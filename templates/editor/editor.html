{% extends "editor/base.html" %}
{% block title %}{{ document.title }}{% endblock %}

{% block extra_head %}
<style>
    .tiptap-editor { outline: none; min-height: 60vh; font-family: 'Georgia', 'Times New Roman', serif; font-size: 16px; line-height: 1.8; color: #1a1a1a; }
    .tiptap-editor:focus { outline: none; }
    .tiptap-editor h1 { font-size: 1.75em; font-weight: 700; margin: 1em 0 0.5em; color: #1B2A4A; }
    .tiptap-editor h2 { font-size: 1.4em; font-weight: 700; margin: 1em 0 0.4em; color: #1B2A4A; }
    .tiptap-editor h3 { font-size: 1.15em; font-weight: 700; margin: 0.8em 0 0.3em; color: #1B2A4A; }
    .tiptap-editor p { margin: 0.4em 0; }
    .tiptap-editor ul { list-style: disc; padding-left: 1.5em; margin: 0.5em 0; }
    .tiptap-editor ol { list-style: decimal; padding-left: 1.5em; margin: 0.5em 0; }
    .tiptap-editor blockquote { border-left: 3px solid #C5A55A; padding-left: 1em; margin: 0.8em 0; color: #555; }
    .tiptap-editor hr { border: none; border-top: 1px solid #ddd; margin: 1.5em 0; }
    .tiptap-editor hr.page-break-node { border-top: 2px dashed #9ca3af; position: relative; margin: 2em 0; }
    .tiptap-editor hr.page-break-node::after { content: 'Page Break'; position: absolute; right: 0; top: -10px; font-size: 11px; color: #6b7280; background: white; padding: 0 4px; }
    .tiptap-editor p.is-editor-empty:first-child::before { content: attr(data-placeholder); float: left; color: #adb5bd; pointer-events: none; height: 0; }
    .toolbar-btn { transition: all 0.1s; }
    .toolbar-btn:hover { background-color: #e5e7eb; }
    .toolbar-btn.is-active { background-color: #1B2A4A; color: white; }
    .footnote-ref-node { cursor: pointer; color: #1B2A4A; font-size: 0.85em; }
    .footnote-ref-node:hover { text-decoration: underline; }
    .research-open #research-sidebar { width: 420px; opacity: 1; }
    #research-sidebar { width: 0; opacity: 0; transition: width 0.2s ease, opacity 0.2s ease; position: relative; }
    .tab-btn-active { background-color: #1B2A4A; color: white; }
    .slash-item-active { background-color: #eef2ff; border-color: #c7d2fe; }
    .version-item-active { border-color: #1B2A4A; background: #f8fafc; }
    .diff-line-added { background: #ecfdf5; color: #166534; display: block; padding: 1px 4px; border-radius: 4px; }
    .diff-line-removed { background: #fef2f2; color: #991b1b; display: block; padding: 1px 4px; border-radius: 4px; }
    .diff-line-same { color: #6b7280; display: block; padding: 1px 4px; }
</style>
{% endblock %}

{% block body %}
<div class="bg-white border-b border-gray-200 px-4 py-2 flex items-center justify-between">
    <div class="flex items-center gap-3">
        <a href="{% url 'dashboard' %}" class="text-gray-400 hover:text-gray-600 transition-colors" title="Back to documents">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        </a>
        <input type="text" id="doc-title" value="{{ document.title }}" class="text-lg font-semibold text-gray-900 border-none focus:outline-none focus:ring-0 bg-transparent w-96" placeholder="Untitled Document">
    </div>
    <div class="flex items-center gap-2">
        <span id="save-status" class="text-xs text-gray-400">Saved</span>
        <button id="open-versions" class="border border-gray-300 px-3 py-1.5 rounded text-sm hover:bg-gray-50">Versions</button>
        <a href="{% url 'export_docx' document.id %}" class="bg-navy text-white px-3 py-1.5 rounded text-sm hover:bg-opacity-90 transition-colors">Word</a>
        <a href="{% url 'export_pdf' document.id %}" class="bg-gold text-navy px-3 py-1.5 rounded text-sm hover:bg-opacity-90 transition-colors">PDF</a>
    </div>
</div>

<div id="toolbar" class="bg-white border-b border-gray-100 px-4 py-1.5 flex items-center gap-1 flex-wrap sticky top-0 z-10">
    <button class="toolbar-btn p-1.5 rounded" data-action="bold">B</button>
    <button class="toolbar-btn p-1.5 rounded italic" data-action="italic">I</button>
    <button class="toolbar-btn p-1.5 rounded underline" data-action="underline">U</button>
    <div class="w-px h-5 bg-gray-200 mx-1"></div>
    <button class="toolbar-btn px-2 py-1 rounded text-xs font-bold" data-action="heading" data-level="1">H1</button>
    <button class="toolbar-btn px-2 py-1 rounded text-xs font-bold" data-action="heading" data-level="2">H2</button>
    <button class="toolbar-btn px-2 py-1 rounded text-xs font-bold" data-action="heading" data-level="3">H3</button>
    <div class="w-px h-5 bg-gray-200 mx-1"></div>
    <button class="toolbar-btn p-1.5 rounded" data-action="bulletList">‚Ä¢ List</button>
    <button class="toolbar-btn p-1.5 rounded" data-action="orderedList">1. List</button>
    <button class="toolbar-btn p-1.5 rounded" data-action="blockquote">Quote</button>
    <div class="w-px h-5 bg-gray-200 mx-1"></div>
    <button class="toolbar-btn p-1.5 rounded" data-action="insertTable">Table</button>
    <button class="toolbar-btn p-1.5 rounded" data-action="addRow">+Row</button>
    <button class="toolbar-btn p-1.5 rounded" data-action="deleteRow">-Row</button>
    <button class="toolbar-btn p-1.5 rounded" data-action="addColumn">+Col</button>
    <button class="toolbar-btn p-1.5 rounded" data-action="deleteColumn">-Col</button>
    <button class="toolbar-btn p-1.5 rounded" data-action="mergeCells">Merge</button>
    <button class="toolbar-btn p-1.5 rounded" data-action="splitCell">Split</button>
    <button class="toolbar-btn p-1.5 rounded" data-action="toggleHeaderRow">Hdr Row</button>
    <button class="toolbar-btn p-1.5 rounded" data-action="toggleHeaderColumn">Hdr Col</button>
    <button class="toolbar-btn p-1.5 rounded" data-action="deleteTable">Del Table</button>
    <div class="w-px h-5 bg-gray-200 mx-1"></div>
    <button class="toolbar-btn p-1.5 rounded" data-action="footnote">Footnote</button>
    <button id="open-footnotes" class="p-1.5 rounded border border-gray-300 text-xs">Manage Notes</button>
    <button class="toolbar-btn p-1.5 rounded" data-action="pageBreak">Page Break</button>
    <div class="w-px h-5 bg-gray-200 mx-1"></div>
    <button class="toolbar-btn p-1.5 rounded" data-action="undo">Undo</button>
    <button class="toolbar-btn p-1.5 rounded" data-action="redo">Redo</button>
    <div class="flex-grow"></div>
    <button id="research-toggle" class="bg-navy text-white px-3 py-1.5 rounded text-xs hover:bg-opacity-90">üîç Research</button>
</div>

<div id="editor-shell" class="flex h-[calc(100vh-110px)] overflow-hidden">
    <div class="flex-1 overflow-y-auto">
        <div class="max-w-4xl mx-auto px-6 py-8">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 px-12 py-10 min-h-[70vh]">
                <div id="editor" class="tiptap-editor"></div>
            </div>
        </div>
    </div>

    <aside id="research-sidebar" class="bg-white border-l border-gray-200 h-full overflow-y-auto shrink-0">
        <div class="p-4 border-b border-gray-100 flex items-center justify-between">
            <h3 class="text-sm font-semibold text-navy">Research & Exemplars</h3>
            <button id="research-close" class="text-gray-400 hover:text-gray-700">‚úï</button>
        </div>
        <div class="p-3 border-b border-gray-100 flex gap-2">
            <button id="tab-search" class="tab-btn tab-btn-active px-3 py-1 text-xs rounded">Search</button>
            <button id="tab-categories" class="tab-btn px-3 py-1 text-xs rounded border">Categories</button>
            <button id="tab-exemplars" class="tab-btn px-3 py-1 text-xs rounded border">Exemplars</button>
        </div>

        <div id="search-panel" class="p-3 space-y-2">
            <input id="research-query" class="w-full border rounded px-2 py-1 text-sm" placeholder="Search case law or ask a legal question..." />
            <div class="grid grid-cols-3 gap-2">
                <button id="run-search" class="px-2 py-1 text-xs bg-gold text-navy rounded">Search</button>
                <button id="run-suggest" class="px-2 py-1 text-xs border rounded">Suggest Selection</button>
                <button id="run-ask" class="px-2 py-1 text-xs border rounded">Ask</button>
            </div>
            <p class="text-xs text-gray-500">Slash command available in editor: <code>/research</code></p>
        </div>

        <div id="categories-panel" class="p-3 hidden"></div>

        <div id="exemplar-panel" class="p-3 hidden space-y-3">
            <div>
                <div class="flex gap-2">
                    <input id="exemplar-query" class="w-full border rounded px-2 py-1 text-sm" placeholder="Search exemplars..." />
                    <button id="run-exemplar-search" class="px-2 py-1 text-xs border rounded">Search</button>
                </div>
                <div class="mt-2 flex gap-2">
                    <button id="run-exemplar-suggest" class="px-2 py-1 text-xs bg-gold text-navy rounded">Suggest for This Doc</button>
                </div>
            </div>

            <form id="exemplar-upload-form" class="border rounded p-2 space-y-2">
                <div class="text-xs font-semibold text-gray-700">Upload Exemplar</div>
                <input type="file" id="exemplar-file" name="file" class="w-full text-xs" accept=".pdf,.docx,.txt,.md,.rtf" required>
                <input type="text" id="exemplar-title" name="title" class="w-full border rounded px-2 py-1 text-xs" placeholder="Title (optional)">
                <div class="grid grid-cols-2 gap-2">
                    <select id="exemplar-document-type" name="document_type_id" class="border rounded px-2 py-1 text-xs">
                        <option value="">Document type</option>
                        {% for dt in document_types %}
                        <option value="{{ dt.id }}">{{ dt.name }}</option>
                        {% endfor %}
                    </select>
                    <select id="exemplar-outcome" name="outcome" class="border rounded px-2 py-1 text-xs">
                        <option value="unknown">Outcome unknown</option>
                        <option value="approved">Approved</option>
                        <option value="denied">Denied</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>
                <input type="text" id="exemplar-case-type" name="case_type" class="w-full border rounded px-2 py-1 text-xs" placeholder="Case type (e.g., asylum)">
                <input type="text" id="exemplar-tags" name="tags" class="w-full border rounded px-2 py-1 text-xs" placeholder="Tags (comma separated)">
                <button type="submit" class="w-full px-2 py-1 text-xs bg-navy text-white rounded">Upload</button>
            </form>
        </div>

        <div id="results" class="p-3 space-y-2"></div>
        <div id="exemplar-results" class="p-3 space-y-2 hidden"></div>

        <div id="case-panel" class="hidden absolute right-0 top-0 w-[420px] h-full bg-white border-l border-gray-200 overflow-y-auto z-20">
            <div class="p-3 border-b flex justify-between items-center">
                <button id="case-back" class="text-xs text-navy">‚Üê Back to results</button>
                <button id="insert-citation-top" class="text-xs bg-gold text-navy px-2 py-1 rounded">Insert Citation</button>
            </div>
            <div id="case-detail" class="p-3 text-sm"></div>
        </div>

        <div id="exemplar-detail-panel" class="hidden absolute right-0 top-0 w-[420px] h-full bg-white border-l border-gray-200 overflow-y-auto z-20">
            <div class="p-3 border-b flex justify-between items-center">
                <button id="exemplar-back" class="text-xs text-navy">‚Üê Back to exemplars</button>
                <button id="insert-exemplar-text" class="text-xs bg-gold text-navy px-2 py-1 rounded">Insert Excerpt</button>
            </div>
            <div id="exemplar-detail" class="p-3 text-sm"></div>
        </div>
    </aside>
</div>

<div id="slash-menu" class="hidden fixed z-40 w-[340px] max-h-[280px] overflow-y-auto rounded-lg border border-gray-200 bg-white shadow-lg"></div>

<div id="footnotes-modal" class="hidden fixed inset-0 z-30 bg-black/30 items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-[780px] max-w-[95vw] max-h-[80vh] overflow-hidden">
        <div class="px-4 py-3 border-b flex justify-between items-center">
            <h3 class="font-semibold text-navy">Footnotes</h3>
            <button id="close-footnotes" class="text-gray-500 hover:text-gray-700">‚úï</button>
        </div>
        <div class="px-4 py-3 border-b flex items-center gap-2">
            <button id="add-footnote-inline" class="bg-navy text-white px-3 py-1 rounded text-sm">Add Footnote</button>
            <span id="footnote-count" class="text-xs text-gray-500"></span>
        </div>
        <div id="footnotes-list" class="p-4 space-y-3 overflow-y-auto" style="max-height:58vh;"></div>
    </div>
</div>

<div id="versions-modal" class="hidden fixed inset-0 z-30 bg-black/30 items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-[1040px] max-w-[97vw] max-h-[86vh] overflow-hidden">
        <div class="px-4 py-3 border-b flex justify-between items-center">
            <h3 class="font-semibold text-navy">Version History</h3>
            <button id="close-versions" class="text-gray-500 hover:text-gray-700">‚úï</button>
        </div>
        <div class="grid grid-cols-[320px_1fr] h-[74vh]">
            <div class="border-r border-gray-200 flex flex-col min-h-0">
                <div class="p-3 border-b space-y-2">
                    <div class="flex items-center gap-2">
                        <input id="snapshot-label" class="border rounded px-2 py-1 text-sm flex-1" placeholder="Snapshot label (optional)">
                        <button id="save-snapshot" class="bg-navy text-white px-3 py-1 rounded text-sm">Save</button>
                    </div>
                    <input id="version-filter" class="w-full border rounded px-2 py-1 text-sm" placeholder="Filter versions...">
                </div>
                <div id="versions-list" class="p-3 space-y-2 overflow-y-auto min-h-0"></div>
            </div>
            <div class="flex flex-col min-h-0">
                <div id="version-detail-empty" class="m-4 rounded border border-dashed border-gray-300 p-6 text-sm text-gray-500">
                    Select a snapshot to preview, compare, rename, delete, or restore.
                </div>
                <div id="version-detail" class="hidden flex-1 min-h-0 flex flex-col">
                    <div class="p-4 border-b space-y-3">
                        <div class="flex items-center justify-between gap-3">
                            <div>
                                <div id="version-meta" class="text-xs text-gray-500"></div>
                                <div id="version-stats" class="text-xs text-gray-500 mt-1"></div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="compare-version" class="border rounded px-2 py-1 text-xs">Compare to Current</button>
                                <button id="restore-version-detail" class="bg-gold text-navy rounded px-2 py-1 text-xs">Restore</button>
                                <button id="delete-version-detail" class="border border-red-300 text-red-700 rounded px-2 py-1 text-xs">Delete</button>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input id="version-label-input" class="border rounded px-2 py-1 text-sm flex-1" placeholder="Version label">
                            <button id="save-version-label" class="bg-navy text-white rounded px-3 py-1 text-xs">Rename</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-0 flex-1 min-h-0">
                        <div class="border-r border-gray-200 flex flex-col min-h-0">
                            <div class="px-3 py-2 text-xs font-semibold text-gray-700 border-b">Snapshot Preview</div>
                            <pre id="version-preview" class="flex-1 min-h-0 overflow-auto p-3 text-xs whitespace-pre-wrap bg-gray-50"></pre>
                        </div>
                        <div class="flex flex-col min-h-0">
                            <div class="px-3 py-2 text-xs font-semibold text-gray-700 border-b">Compare / Diff</div>
                            <div id="version-diff" class="flex-1 min-h-0 overflow-auto p-3 text-xs bg-white text-gray-600">
                                Click "Compare to Current" to generate line-level differences.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{{ document.content|json_script:"initial-doc-content" }}
{% endblock %}

{% block extra_scripts %}
<script type="importmap">{"imports":{
  "@tiptap/core":"https://esm.sh/@tiptap/core@2.11.5",
  "@tiptap/starter-kit":"https://esm.sh/@tiptap/starter-kit@2.11.5",
  "@tiptap/extension-underline":"https://esm.sh/@tiptap/extension-underline@2.11.5",
  "@tiptap/extension-placeholder":"https://esm.sh/@tiptap/extension-placeholder@2.11.5",
  "@tiptap/extension-table":"https://esm.sh/@tiptap/extension-table@2.11.5",
  "@tiptap/extension-table-row":"https://esm.sh/@tiptap/extension-table-row@2.11.5",
  "@tiptap/extension-table-cell":"https://esm.sh/@tiptap/extension-table-cell@2.11.5",
  "@tiptap/extension-table-header":"https://esm.sh/@tiptap/extension-table-header@2.11.5",
  "@tiptap/extension-superscript":"https://esm.sh/@tiptap/extension-superscript@2.11.5"
}}</script>
<script type="module">
import { Editor, Node } from '@tiptap/core';
import StarterKit from '@tiptap/starter-kit';
import Underline from '@tiptap/extension-underline';
import Placeholder from '@tiptap/extension-placeholder';
import Table from '@tiptap/extension-table';
import TableRow from '@tiptap/extension-table-row';
import TableCell from '@tiptap/extension-table-cell';
import TableHeader from '@tiptap/extension-table-header';
import Superscript from '@tiptap/extension-superscript';

const docId = '{{ document.id }}';
const csrfToken = '{{ csrf_token }}';
let currentCase = null;
let currentExemplar = null;
let isSaving = false;
let saveTimeout = null;
let selectedVersionId = null;
let selectedVersionDetail = null;
let versions = [];
let versionFilterText = '';
let isNormalizingFootnotes = false;
let slashState = {
  open: false,
  items: [],
  selectedIndex: 0,
  range: null,
};

const PageBreak = Node.create({
  name: 'pageBreak',
  group: 'block',
  selectable: true,
  parseHTML() { return [{ tag: 'hr[data-page-break]' }]; },
  renderHTML() { return ['hr', { 'data-page-break': 'true', class: 'page-break-node' }]; },
  addCommands() {
    return {
      setPageBreak: () => ({ commands }) => commands.insertContent({ type: this.name }),
    };
  },
});

const FootnoteReference = Node.create({
  name: 'footnoteReference',
  group: 'inline',
  inline: true,
  atom: true,
  selectable: true,
  addAttributes() {
    return {
      noteId: { default: null },
      number: { default: 1 },
      text: { default: '' },
    };
  },
  parseHTML() {
    return [{ tag: 'sup[data-footnote-id]' }];
  },
  renderHTML({ HTMLAttributes }) {
    const attrs = { ...HTMLAttributes };
    const number = attrs.number || '?';
    attrs['data-footnote-id'] = attrs.noteId || '';
    attrs.class = `footnote-ref-node ${attrs.class || ''}`.trim();
    return ['sup', attrs, `[${number}]`];
  },
});

let initialContent;
try {
  initialContent = JSON.parse(document.getElementById('initial-doc-content').textContent);
} catch {
  initialContent = { type: 'doc', content: [{ type: 'paragraph' }] };
}

const editor = new Editor({
  element: document.getElementById('editor'),
  extensions: [
    StarterKit,
    Underline,
    Superscript,
    Placeholder.configure({ placeholder: 'Start writing...' }),
    Table.configure({ resizable: true }),
    TableRow,
    TableHeader,
    TableCell,
    PageBreak,
    FootnoteReference,
  ],
  content: initialContent,
  editorProps: { attributes: { class: 'tiptap-editor' } },
});

const saveStatus = document.getElementById('save-status');
const versionsModal = document.getElementById('versions-modal');
const footnotesModal = document.getElementById('footnotes-modal');
const slashMenu = document.getElementById('slash-menu');
const editorShell = document.getElementById('editor-shell');

async function saveContent(opts = {}) {
  if (isSaving) return;
  isSaving = true;
  saveStatus.textContent = 'Saving...';
  try {
    const response = await fetch(`/api/save/${docId}/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
      body: JSON.stringify({
        content: editor.getJSON(),
        force_snapshot: !!opts.forceSnapshot,
        snapshot_label: opts.snapshotLabel || '',
      }),
    });
    saveStatus.textContent = response.ok ? 'Saved' : 'Error saving';
  } catch {
    saveStatus.textContent = 'Error saving';
  }
  isSaving = false;
}

editor.on('update', () => {
  normalizeFootnotes();
  clearTimeout(saveTimeout);
  saveStatus.textContent = 'Unsaved changes';
  saveTimeout = setTimeout(() => saveContent(), 3000);
  updateToolbar();
  maybeOpenSlashMenu();
  if (!footnotesModal.classList.contains('hidden')) {
    renderFootnotesModal();
  }
});

editor.view.dom.addEventListener('keydown', (e) => {
  if (handleSlashKeydown(e)) {
    return;
  }
  if (e.key === 'Tab' && editor.isActive('table')) {
    e.preventDefault();
    if (e.shiftKey) {
      editor.chain().focus().goToPreviousCell().run();
    } else {
      editor.chain().focus().goToNextCell().run();
    }
  }
});

editor.on('selectionUpdate', () => {
  updateToolbar();
  maybeOpenSlashMenu();
});

document.getElementById('doc-title').addEventListener('input', (() => {
  let timeout = null;
  return () => {
    clearTimeout(timeout);
    timeout = setTimeout(async () => {
      await fetch(`/api/title/${docId}/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
        body: JSON.stringify({ title: document.getElementById('doc-title').value }),
      });
    }, 800);
  };
})());

document.querySelectorAll('.toolbar-btn').forEach(btn => btn.addEventListener('click', () => {
  const a = btn.dataset.action;
  if (a === 'bold') editor.chain().focus().toggleBold().run();
  if (a === 'italic') editor.chain().focus().toggleItalic().run();
  if (a === 'underline') editor.chain().focus().toggleUnderline().run();
  if (a === 'heading') editor.chain().focus().toggleHeading({ level: parseInt(btn.dataset.level, 10) }).run();
  if (a === 'bulletList') editor.chain().focus().toggleBulletList().run();
  if (a === 'orderedList') editor.chain().focus().toggleOrderedList().run();
  if (a === 'blockquote') editor.chain().focus().toggleBlockquote().run();
  if (a === 'insertTable') editor.chain().focus().insertTable({ rows: 3, cols: 3, withHeaderRow: true }).run();
  if (a === 'addRow') editor.chain().focus().addRowAfter().run();
  if (a === 'deleteRow') editor.chain().focus().deleteRow().run();
  if (a === 'addColumn') editor.chain().focus().addColumnAfter().run();
  if (a === 'deleteColumn') editor.chain().focus().deleteColumn().run();
  if (a === 'mergeCells') editor.chain().focus().mergeCells().run();
  if (a === 'splitCell') editor.chain().focus().splitCell().run();
  if (a === 'toggleHeaderRow') editor.chain().focus().toggleHeaderRow().run();
  if (a === 'toggleHeaderColumn') editor.chain().focus().toggleHeaderColumn().run();
  if (a === 'deleteTable') editor.chain().focus().deleteTable().run();
  if (a === 'footnote') insertFootnoteFromPrompt();
  if (a === 'pageBreak') editor.chain().focus().setPageBreak().run();
  if (a === 'undo') editor.chain().focus().undo().run();
  if (a === 'redo') editor.chain().focus().redo().run();
  updateToolbar();
}));

function updateToolbar() {
  document.querySelectorAll('.toolbar-btn').forEach(btn => {
    const a = btn.dataset.action;
    btn.classList.toggle('is-active',
      (a === 'bold' && editor.isActive('bold')) ||
      (a === 'italic' && editor.isActive('italic')) ||
      (a === 'underline' && editor.isActive('underline')) ||
      (a === 'heading' && editor.isActive('heading', { level: parseInt(btn.dataset.level || '1', 10) })) ||
      (a === 'bulletList' && editor.isActive('bulletList')) ||
      (a === 'orderedList' && editor.isActive('orderedList')) ||
      (a === 'blockquote' && editor.isActive('blockquote')) ||
      ((a === 'insertTable' || a === 'addRow' || a === 'deleteRow' || a === 'addColumn' || a === 'deleteColumn' || a === 'deleteTable' || a === 'mergeCells' || a === 'splitCell' || a === 'toggleHeaderRow' || a === 'toggleHeaderColumn') && editor.isActive('table')));
  });
}

function openSidebar() { editorShell.classList.add('research-open'); }
function closeSidebar() {
  editorShell.classList.remove('research-open');
  document.getElementById('case-panel').classList.add('hidden');
  document.getElementById('exemplar-detail-panel').classList.add('hidden');
}
document.getElementById('research-toggle').addEventListener('click', openSidebar);
document.getElementById('research-close').addEventListener('click', closeSidebar);

function validityBadge(status) {
  if (status === 'good_law') return '<span class="text-green-700">‚úÖ good law</span>';
  if (status === 'questioned') return '<span class="text-yellow-700">‚ö†Ô∏è questioned</span>';
  if (status === 'overruled') return '<span class="text-red-700">‚ùå overruled</span>';
  return '<span class="text-gray-500">‚¨ú unknown</span>';
}

function caseCard(item) {
  const holding = item.holding || item.summary || '';
  const escaped = JSON.stringify(item).replace(/'/g, '&#39;');
  return `<div class="border rounded p-2 hover:border-navy bg-white">
    <button class="case-open text-left w-full text-sm font-semibold text-navy" data-id="${item.document_id}">${item.case_name || 'Unknown case'}</button>
    <div class="text-xs text-gray-600">${item.citation || ''}</div>
    <div class="text-xs">${validityBadge(item.validity_status)}</div>
    <div class="text-xs text-gray-700 mt-1">${holding.slice(0, 220)}</div>
    <div class="mt-2 flex gap-2">
      <button class="insert-citation text-xs bg-gold text-navy px-2 py-1 rounded" data-case='${escaped}'>Insert Citation</button>
      <button class="similar text-xs border px-2 py-1 rounded" data-id="${item.document_id}">Find Similar</button>
    </div>
  </div>`;
}

function renderResults(items) {
  const node = document.getElementById('results');
  node.classList.remove('hidden');
  document.getElementById('exemplar-results').classList.add('hidden');
  node.innerHTML = items.length ? items.map(caseCard).join('') : '<div class="text-xs text-gray-500">No results.</div>';
  node.querySelectorAll('.insert-citation').forEach(btn => btn.addEventListener('click', () => insertCitation(JSON.parse(btn.dataset.case))));
  node.querySelectorAll('.case-open').forEach(btn => btn.addEventListener('click', () => openCase(btn.dataset.id)));
  node.querySelectorAll('.similar').forEach(btn => btn.addEventListener('click', async () => {
    const res = await fetch(`/api/research/similar/${btn.dataset.id}/`);
    const data = await res.json();
    renderResults(data.results || []);
  }));
}

function renderAskAnswer(payload) {
  const answer = payload.answer || 'No answer returned.';
  const citations = payload.citations || [];
  const node = document.getElementById('results');
  document.getElementById('exemplar-results').classList.add('hidden');
  node.classList.remove('hidden');
  node.innerHTML = `
    <div class="border rounded p-3 bg-white">
      <h4 class="text-sm font-semibold text-navy mb-2">Answer</h4>
      <pre class="whitespace-pre-wrap text-xs text-gray-800">${answer}</pre>
    </div>
    <div class="border rounded p-3 bg-white">
      <h4 class="text-sm font-semibold text-navy mb-2">Citations</h4>
      <div class="space-y-2">
        ${citations.map((c, idx) => `
          <div class="text-xs border rounded p-2">
            <div class="font-semibold">[${idx + 1}] ${c.case_name || 'Unknown case'}</div>
            <div class="text-gray-600">${c.citation || ''}</div>
            <div class="mt-1 flex gap-2">
              <button class="ask-open-case border rounded px-2 py-0.5" data-id="${c.document_id}">Open Case</button>
              <button class="ask-insert-case border rounded px-2 py-0.5" data-case='${JSON.stringify(c).replace(/'/g, '&#39;')}'>Insert Citation</button>
            </div>
          </div>
        `).join('')}
      </div>
    </div>`;

  node.querySelectorAll('.ask-open-case').forEach(btn => btn.addEventListener('click', () => openCase(btn.dataset.id)));
  node.querySelectorAll('.ask-insert-case').forEach(btn => btn.addEventListener('click', () => insertCitation(JSON.parse(btn.dataset.case))));
}

async function runSuggest(text) {
  const res = await fetch('/api/research/suggest/', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
    body: JSON.stringify({ text }),
  });
  const data = await res.json();
  renderResults(data.results || []);
}

async function runAsk(question) {
  const res = await fetch('/api/research/ask/', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
    body: JSON.stringify({ question }),
  });
  const data = await res.json();
  if (!res.ok) {
    renderAskAnswer({ answer: data.error || 'Unable to answer this question.', citations: [] });
    return;
  }
  renderAskAnswer(data);
}

async function runCategory(slug) {
  const res = await fetch(`/api/research/category/${encodeURIComponent(slug)}/`);
  const data = await res.json();
  renderResults(data.results || []);
}

function insertCitation(item) {
  const date = item.decision_date || item.date || null;
  const year = date ? new Date(date).getUTCFullYear() : '';
  const court = item.court || '';
  const courtYear = court && year ? ` (${court} ${year})` : (court || year ? ` (${court}${year ? ` ${year}` : ''})` : '');
  editor.chain().focus().insertContent([
    { type: 'text', text: item.case_name || '', marks: [{ type: 'italic' }] },
    { type: 'text', text: `, ${item.citation || ''}${courtYear}` },
  ]).run();
}

document.getElementById('insert-citation-top').addEventListener('click', () => {
  if (currentCase) insertCitation(currentCase);
});

async function openCase(docId) {
  const res = await fetch(`/api/research/case/${docId}/`);
  const data = await res.json();
  currentCase = data;
  document.getElementById('case-panel').classList.remove('hidden');
  document.getElementById('case-detail').innerHTML = `
    <h4 class="font-semibold text-navy">${data.case_name || ''}</h4>
    <div class="text-xs text-gray-600">${data.citation || ''}</div>
    <div class="text-xs mt-1">${validityBadge(data.validity?.status)}</div>
    <h5 class="mt-3 font-semibold text-xs text-gray-700">Holdings</h5>
    ${(data.holdings || []).map(h => `<div class="text-xs mt-1"><span class="font-semibold">${h.legal_issue || ''}</span><br>${h.rule || ''}</div>`).join('')}
    <h5 class="mt-3 font-semibold text-xs text-gray-700">Full Text</h5>
    <pre class="whitespace-pre-wrap text-xs bg-gray-50 p-2 rounded mt-1">${(data.full_text || '').slice(0, 20000)}</pre>`;
}

document.getElementById('case-back').addEventListener('click', () => document.getElementById('case-panel').classList.add('hidden'));

function setTab(tabName) {
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('tab-btn-active');
    btn.classList.add('border');
  });

  const searchPanel = document.getElementById('search-panel');
  const categoriesPanel = document.getElementById('categories-panel');
  const exemplarPanel = document.getElementById('exemplar-panel');
  const researchResults = document.getElementById('results');
  const exemplarResults = document.getElementById('exemplar-results');

  searchPanel.classList.add('hidden');
  categoriesPanel.classList.add('hidden');
  exemplarPanel.classList.add('hidden');

  if (tabName === 'search') {
    document.getElementById('tab-search').classList.add('tab-btn-active');
    document.getElementById('tab-search').classList.remove('border');
    searchPanel.classList.remove('hidden');
    researchResults.classList.remove('hidden');
    exemplarResults.classList.add('hidden');
  }
  if (tabName === 'categories') {
    document.getElementById('tab-categories').classList.add('tab-btn-active');
    document.getElementById('tab-categories').classList.remove('border');
    categoriesPanel.classList.remove('hidden');
    researchResults.classList.remove('hidden');
    exemplarResults.classList.add('hidden');
    loadCategories();
  }
  if (tabName === 'exemplars') {
    document.getElementById('tab-exemplars').classList.add('tab-btn-active');
    document.getElementById('tab-exemplars').classList.remove('border');
    exemplarPanel.classList.remove('hidden');
    researchResults.classList.add('hidden');
    exemplarResults.classList.remove('hidden');
    if (!document.getElementById('exemplar-results').dataset.loaded) {
      suggestExemplarsForDocument();
    }
  }
}

async function loadCategories() {
  const res = await fetch('/api/research/categories/');
  const data = await res.json();
  document.getElementById('categories-panel').innerHTML = (data.categories || []).map(c => `
    <button class="cat-btn w-full text-left text-sm p-2 border-b hover:bg-gray-50" data-slug="${c.slug}">
      <div class="font-medium">${c.name}</div>
      <div class="text-xs text-gray-500">${c.description || ''}</div>
    </button>
  `).join('');
  document.querySelectorAll('.cat-btn').forEach(btn => btn.addEventListener('click', () => runCategory(btn.dataset.slug)));
}

document.getElementById('run-search').addEventListener('click', () => runSuggest(document.getElementById('research-query').value));
document.getElementById('run-suggest').addEventListener('click', () => {
  const selected = editor.state.doc.textBetween(editor.state.selection.from, editor.state.selection.to, ' ');
  runSuggest(selected || editor.getText().slice(0, 1200));
});
document.getElementById('run-ask').addEventListener('click', () => {
  const question = document.getElementById('research-query').value.trim();
  if (!question) return;
  runAsk(question);
});

document.getElementById('tab-search').addEventListener('click', () => setTab('search'));
document.getElementById('tab-categories').addEventListener('click', () => setTab('categories'));
document.getElementById('tab-exemplars').addEventListener('click', () => setTab('exemplars'));

function exemplarCard(item) {
  return `<div class="border rounded p-2 bg-white hover:border-navy">
    <button class="exemplar-open text-left w-full text-sm font-semibold text-navy" data-id="${item.id}">${item.title}</button>
    <div class="text-xs text-gray-600">${item.document_type || 'No type'} ¬∑ ${item.case_type || 'No case type'}</div>
    <div class="text-xs mt-1">Outcome: ${item.outcome || 'unknown'}</div>
    <div class="text-xs text-gray-700 mt-1">${(item.snippet || '').slice(0, 220)}</div>
    <div class="mt-2 flex gap-2">
      <button class="exemplar-insert border rounded px-2 py-0.5 text-xs" data-id="${item.id}">Insert Excerpt</button>
    </div>
  </div>`;
}

function renderExemplarResults(items) {
  const node = document.getElementById('exemplar-results');
  node.dataset.loaded = '1';
  node.innerHTML = items.length ? items.map(exemplarCard).join('') : '<div class="text-xs text-gray-500">No exemplars found.</div>';
  node.querySelectorAll('.exemplar-open').forEach(btn => btn.addEventListener('click', () => openExemplar(btn.dataset.id)));
  node.querySelectorAll('.exemplar-insert').forEach(btn => btn.addEventListener('click', async () => {
    const detail = await getExemplarDetail(btn.dataset.id);
    insertExemplarText(detail.extracted_text || detail.snippet || '');
  }));
}

async function searchExemplars(query) {
  const res = await fetch(`/api/exemplars/search/?q=${encodeURIComponent(query || '')}`);
  const data = await res.json();
  renderExemplarResults(data.results || []);
}

async function suggestExemplarsForDocument() {
  const res = await fetch(`/api/exemplars/suggest/${docId}/`);
  const data = await res.json();
  renderExemplarResults(data.results || []);
}

async function getExemplarDetail(exemplarId) {
  const res = await fetch(`/api/exemplars/${exemplarId}/`);
  return await res.json();
}

async function openExemplar(exemplarId) {
  const data = await getExemplarDetail(exemplarId);
  currentExemplar = data;
  document.getElementById('exemplar-detail-panel').classList.remove('hidden');
  document.getElementById('exemplar-detail').innerHTML = `
    <h4 class="font-semibold text-navy">${data.title || ''}</h4>
    <div class="text-xs text-gray-600">${data.document_type || ''} ¬∑ ${data.case_type || ''}</div>
    <div class="text-xs mt-1">Outcome: ${data.outcome || 'unknown'}</div>
    <h5 class="mt-3 font-semibold text-xs text-gray-700">Extracted Text</h5>
    <pre class="whitespace-pre-wrap text-xs bg-gray-50 p-2 rounded mt-1">${(data.extracted_text || '').slice(0, 30000)}</pre>`;
}

function insertExemplarText(text) {
  if (!text) return;
  const excerpt = text.length > 1800 ? `${text.slice(0, 1800)}...` : text;
  editor.chain().focus().insertContent(excerpt).run();
}

document.getElementById('insert-exemplar-text').addEventListener('click', () => {
  if (currentExemplar) insertExemplarText(currentExemplar.extracted_text || currentExemplar.snippet || '');
});
document.getElementById('exemplar-back').addEventListener('click', () => document.getElementById('exemplar-detail-panel').classList.add('hidden'));

const exemplarForm = document.getElementById('exemplar-upload-form');
exemplarForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData();
  const fileInput = document.getElementById('exemplar-file');
  if (!fileInput.files.length) return;

  formData.append('file', fileInput.files[0]);
  formData.append('title', document.getElementById('exemplar-title').value);
  formData.append('document_type_id', document.getElementById('exemplar-document-type').value);
  formData.append('outcome', document.getElementById('exemplar-outcome').value);
  formData.append('case_type', document.getElementById('exemplar-case-type').value);
  formData.append('tags', document.getElementById('exemplar-tags').value);

  const res = await fetch('/api/exemplars/upload/', {
    method: 'POST',
    headers: { 'X-CSRFToken': csrfToken },
    body: formData,
  });

  if (!res.ok) {
    const data = await res.json();
    window.alert(data.error || 'Upload failed');
    return;
  }

  exemplarForm.reset();
  await suggestExemplarsForDocument();
});

document.getElementById('run-exemplar-search').addEventListener('click', () => {
  searchExemplars(document.getElementById('exemplar-query').value);
});
document.getElementById('run-exemplar-suggest').addEventListener('click', suggestExemplarsForDocument);

function renderVersions(items) {
  const node = document.getElementById('versions-list');
  if (!items.length) {
    node.innerHTML = '<div class="text-sm text-gray-500">No snapshots yet.</div>';
    selectedVersionId = null;
    showEmptyVersionDetail();
    return;
  }
  const filtered = items.filter(v => {
    if (!versionFilterText) return true;
    const haystack = `${v.label || ''} ${new Date(v.created_at).toLocaleString()}`.toLowerCase();
    return haystack.includes(versionFilterText.toLowerCase());
  });
  if (!filtered.length) {
    node.innerHTML = '<div class="text-sm text-gray-500">No versions match that filter.</div>';
    return;
  }
  node.innerHTML = filtered.map(v => `
    <button class="version-item w-full text-left border rounded px-3 py-2 ${selectedVersionId === String(v.id) ? 'version-item-active' : ''}" data-id="${v.id}">
      <div class="flex items-start justify-between gap-2">
        <div class="min-w-0">
          <div class="text-sm font-medium truncate">${v.label || 'Snapshot'}</div>
          <div class="text-xs text-gray-500">${new Date(v.created_at).toLocaleString()}</div>
          <div class="text-xs text-gray-500 mt-1">${v.word_count || 0} words ¬∑ ${v.char_count || 0} chars</div>
        </div>
        <div class="flex flex-col items-end gap-1">
          ${v.is_auto ? '<span class="text-[10px] px-1.5 py-0.5 rounded bg-gray-100 text-gray-600">AUTO</span>' : '<span class="text-[10px] px-1.5 py-0.5 rounded bg-blue-50 text-blue-700">MANUAL</span>'}
          ${v.is_restore_point ? '<span class="text-[10px] px-1.5 py-0.5 rounded bg-amber-50 text-amber-700">RESTORE PT</span>' : ''}
        </div>
      </div>
      <div class="text-xs text-gray-600 mt-2 line-clamp-2">${escapeHtml(v.preview || '')}</div>
    </button>
  `).join('');
  node.querySelectorAll('.version-item').forEach(btn => btn.addEventListener('click', () => loadVersionDetail(btn.dataset.id)));
}

async function loadVersions() {
  const res = await fetch(`/api/versions/${docId}/`);
  const data = await res.json();
  versions = data.versions || [];
  renderVersions(versions);
  if (!versions.length) return;
  const candidate = selectedVersionId && versions.find(v => String(v.id) === String(selectedVersionId))
    ? selectedVersionId
    : String(versions[0].id);
  await loadVersionDetail(candidate);
}

async function createSnapshot() {
  const label = document.getElementById('snapshot-label').value.trim();
  await fetch(`/api/snapshot/${docId}/`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
    body: JSON.stringify({ label }),
  });
  document.getElementById('snapshot-label').value = '';
  await loadVersions();
}

async function restoreVersion(versionId) {
  if (!window.confirm('Restore this version? Current content will be replaced.')) return;
  const res = await fetch(`/api/restore/${docId}/${versionId}/`, {
    method: 'POST',
    headers: { 'X-CSRFToken': csrfToken },
  });
  const data = await res.json();
  if (!res.ok) {
    window.alert(data.error || 'Unable to restore version');
    return;
  }
  editor.commands.setContent(data.content || { type: 'doc', content: [{ type: 'paragraph' }] });
  saveStatus.textContent = 'Restored';
  await loadVersions();
}

document.getElementById('open-versions').addEventListener('click', async () => {
  versionsModal.classList.remove('hidden');
  versionsModal.classList.add('flex');
  await loadVersions();
});
document.getElementById('close-versions').addEventListener('click', () => {
  versionsModal.classList.add('hidden');
  versionsModal.classList.remove('flex');
});
document.getElementById('save-snapshot').addEventListener('click', createSnapshot);
document.getElementById('version-filter').addEventListener('input', (e) => {
  versionFilterText = e.target.value || '';
  renderVersions(versions);
});

async function loadVersionDetail(versionId) {
  selectedVersionId = String(versionId);
  renderVersions(versions);
  const res = await fetch(`/api/version/${docId}/${versionId}/`);
  const data = await res.json();
  if (!res.ok) {
    window.alert(data.error || 'Unable to load version');
    return;
  }
  selectedVersionDetail = data;
  showVersionDetail(data);
}

function showEmptyVersionDetail() {
  selectedVersionDetail = null;
  document.getElementById('version-detail').classList.add('hidden');
  document.getElementById('version-detail-empty').classList.remove('hidden');
}

function showVersionDetail(data) {
  document.getElementById('version-detail-empty').classList.add('hidden');
  document.getElementById('version-detail').classList.remove('hidden');
  document.getElementById('version-meta').textContent = `Snapshot #${data.id} ¬∑ ${new Date(data.created_at).toLocaleString()}`;
  document.getElementById('version-stats').textContent = `${data.word_count || 0} words ¬∑ ${data.char_count || 0} chars`;
  document.getElementById('version-label-input').value = data.label || '';
  document.getElementById('version-preview').textContent = data.full_text || data.preview || '';
  document.getElementById('version-diff').innerHTML = 'Click "Compare to Current" to generate line-level differences.';
}

document.getElementById('save-version-label').addEventListener('click', async () => {
  if (!selectedVersionId) return;
  const label = document.getElementById('version-label-input').value.trim();
  const res = await fetch(`/api/version/${docId}/${selectedVersionId}/label/`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
    body: JSON.stringify({ label }),
  });
  const data = await res.json();
  if (!res.ok) {
    window.alert(data.message || data.error || 'Unable to rename version');
    return;
  }
  await loadVersions();
  await loadVersionDetail(selectedVersionId);
});

document.getElementById('delete-version-detail').addEventListener('click', async () => {
  if (!selectedVersionId) return;
  if (!window.confirm('Delete this snapshot? This cannot be undone.')) return;
  const res = await fetch(`/api/version/${docId}/${selectedVersionId}/delete/`, {
    method: 'POST',
    headers: { 'X-CSRFToken': csrfToken },
  });
  const data = await res.json();
  if (!res.ok) {
    window.alert(data.message || data.error || 'Unable to delete version');
    return;
  }
  await loadVersions();
});

document.getElementById('restore-version-detail').addEventListener('click', async () => {
  if (!selectedVersionId) return;
  await restoreVersion(selectedVersionId);
});

document.getElementById('compare-version').addEventListener('click', () => {
  if (!selectedVersionDetail) return;
  const diff = buildLineDiff(
    selectedVersionDetail.current_text || '',
    selectedVersionDetail.full_text || '',
  );
  const added = diff.filter(line => line.type === 'added').length;
  const removed = diff.filter(line => line.type === 'removed').length;
  const rows = diff.length
    ? diff.map(line => `<span class="diff-line-${line.type}">${escapeHtml(line.prefix + line.text)}</span>`).join('')
    : '<span class="diff-line-same">No textual differences detected.</span>';
  document.getElementById('version-diff').innerHTML = `
    <div class="mb-2 text-xs text-gray-500">+${added} added lines ¬∑ -${removed} removed lines</div>
    ${rows}
  `;
});

window.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    hideSlashMenu();
  }
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault();
    clearTimeout(saveTimeout);
    saveContent({ forceSnapshot: false });
  }
});
window.addEventListener('beforeunload', () => {
  if (saveTimeout) saveContent();
});

function escapeHtml(str) {
  return (str || '')
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#39;');
}

function buildLineDiff(currentText, versionText) {
  const a = (currentText || '').split('\n');
  const b = (versionText || '').split('\n');
  const output = [];
  let i = 0;
  let j = 0;

  while ((i < a.length || j < b.length) && output.length < 1200) {
    const oldLine = i < a.length ? a[i] : null;
    const newLine = j < b.length ? b[j] : null;

    if (oldLine === newLine) {
      i += 1;
      j += 1;
      continue;
    }
    if (oldLine !== null && j + 1 < b.length && oldLine === b[j + 1]) {
      output.push({ type: 'added', prefix: '+ ', text: b[j] });
      j += 1;
      continue;
    }
    if (newLine !== null && i + 1 < a.length && a[i + 1] === newLine) {
      output.push({ type: 'removed', prefix: '- ', text: a[i] });
      i += 1;
      continue;
    }
    if (oldLine !== null) {
      output.push({ type: 'removed', prefix: '- ', text: oldLine });
      i += 1;
    }
    if (newLine !== null) {
      output.push({ type: 'added', prefix: '+ ', text: newLine });
      j += 1;
    }
  }

  if (i < a.length || j < b.length) {
    output.push({ type: 'same', prefix: '‚Ä¶ ', text: 'Diff truncated for readability' });
  }
  return output;
}

function generateNoteId() {
  return `fn_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;
}

function collectFootnotes() {
  const list = [];
  const byId = new Map();
  editor.state.doc.descendants((node, pos) => {
    if (node.type.name !== 'footnoteReference') return;
    const noteId = node.attrs.noteId || `legacy_${pos}`;
    const current = byId.get(noteId);
    if (!current) {
      const item = {
        noteId,
        number: node.attrs.number || list.length + 1,
        text: node.attrs.text || '',
        pos,
      };
      byId.set(noteId, item);
      list.push(item);
    } else if (!current.text && node.attrs.text) {
      current.text = node.attrs.text;
    }
  });
  list.sort((a, b) => a.number - b.number);
  return list;
}

function normalizeFootnotes() {
  if (isNormalizingFootnotes) return;
  const order = [];
  const textById = new Map();
  editor.state.doc.descendants((node, pos) => {
    if (node.type.name !== 'footnoteReference') return;
    const noteId = node.attrs.noteId || `legacy_${pos}`;
    if (!order.includes(noteId)) {
      order.push(noteId);
    }
    if (!textById.get(noteId) && node.attrs.text) {
      textById.set(noteId, node.attrs.text);
    }
  });

  const numberById = new Map(order.map((noteId, idx) => [noteId, idx + 1]));
  let changed = false;
  const tr = editor.state.tr;
  editor.state.doc.descendants((node, pos) => {
    if (node.type.name !== 'footnoteReference') return;
    const existingId = node.attrs.noteId || `legacy_${pos}`;
    const newAttrs = {
      ...node.attrs,
      noteId: existingId,
      number: numberById.get(existingId) || node.attrs.number || 1,
      text: textById.get(existingId) || node.attrs.text || '',
    };
    const same = Object.keys(newAttrs).every(key => String(node.attrs[key] ?? '') === String(newAttrs[key] ?? ''));
    if (!same) {
      tr.setNodeMarkup(pos, undefined, newAttrs);
      changed = true;
    }
  });
  if (changed) {
    isNormalizingFootnotes = true;
    editor.view.dispatch(tr);
    isNormalizingFootnotes = false;
  }
}

function insertFootnoteFromPrompt(defaultText = '') {
  const text = window.prompt('Footnote text:', defaultText || '');
  if (text === null) return;
  const clean = text.trim();
  if (!clean) return;
  editor.chain().focus().insertContent({
    type: 'footnoteReference',
    attrs: {
      noteId: generateNoteId(),
      number: 999,
      text: clean,
    },
  }).run();
  normalizeFootnotes();
}

function updateFootnoteText(noteId, newText) {
  const tr = editor.state.tr;
  let changed = false;
  editor.state.doc.descendants((node, pos) => {
    if (node.type.name !== 'footnoteReference') return;
    if (node.attrs.noteId !== noteId) return;
    const attrs = { ...node.attrs, text: newText };
    tr.setNodeMarkup(pos, undefined, attrs);
    changed = true;
  });
  if (changed) {
    editor.view.dispatch(tr);
    normalizeFootnotes();
  }
}

function deleteFootnote(noteId) {
  const ranges = [];
  editor.state.doc.descendants((node, pos) => {
    if (node.type.name !== 'footnoteReference') return;
    if (node.attrs.noteId === noteId) {
      ranges.push({ from: pos, to: pos + node.nodeSize });
    }
  });
  if (!ranges.length) return;
  const tr = editor.state.tr;
  ranges.sort((a, b) => b.from - a.from).forEach(r => tr.delete(r.from, r.to));
  editor.view.dispatch(tr);
  normalizeFootnotes();
}

function jumpToFootnote(noteId) {
  let targetPos = null;
  editor.state.doc.descendants((node, pos) => {
    if (targetPos !== null) return false;
    if (node.type.name === 'footnoteReference' && node.attrs.noteId === noteId) {
      targetPos = pos;
      return false;
    }
    return undefined;
  });
  if (targetPos !== null) {
    editor.chain().focus(targetPos).run();
  }
}

function renderFootnotesModal() {
  const notes = collectFootnotes();
  document.getElementById('footnote-count').textContent = `${notes.length} footnote${notes.length === 1 ? '' : 's'}`;
  const listNode = document.getElementById('footnotes-list');
  if (!notes.length) {
    listNode.innerHTML = '<div class="text-sm text-gray-500">No footnotes yet. Use "Add Footnote" to create one at the cursor.</div>';
    return;
  }
  listNode.innerHTML = notes.map(note => `
    <div class="border rounded p-3">
      <div class="flex items-center justify-between mb-2">
        <div class="text-sm font-semibold text-navy">[${note.number}] Footnote</div>
        <div class="flex gap-2">
          <button class="goto-footnote text-xs border rounded px-2 py-1" data-note-id="${note.noteId}">Go To</button>
          <button class="delete-footnote text-xs border border-red-300 text-red-700 rounded px-2 py-1" data-note-id="${note.noteId}">Delete</button>
        </div>
      </div>
      <textarea class="footnote-text w-full border rounded p-2 text-sm" rows="3" data-note-id="${note.noteId}" placeholder="Footnote text">${escapeHtml(note.text || '')}</textarea>
    </div>
  `).join('');

  listNode.querySelectorAll('.goto-footnote').forEach(btn => btn.addEventListener('click', () => {
    jumpToFootnote(btn.dataset.noteId);
    footnotesModal.classList.add('hidden');
    footnotesModal.classList.remove('flex');
  }));
  listNode.querySelectorAll('.delete-footnote').forEach(btn => btn.addEventListener('click', () => {
    if (!window.confirm('Delete this footnote marker and note text everywhere in the document?')) return;
    deleteFootnote(btn.dataset.noteId);
    renderFootnotesModal();
  }));
  listNode.querySelectorAll('.footnote-text').forEach(input => {
    input.addEventListener('blur', () => {
      updateFootnoteText(input.dataset.noteId, input.value.trim());
    });
    input.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
        updateFootnoteText(input.dataset.noteId, input.value.trim());
      }
    });
  });
}

function showFootnotesModal() {
  renderFootnotesModal();
  footnotesModal.classList.remove('hidden');
  footnotesModal.classList.add('flex');
}

document.getElementById('open-footnotes').addEventListener('click', showFootnotesModal);
document.getElementById('close-footnotes').addEventListener('click', () => {
  footnotesModal.classList.add('hidden');
  footnotesModal.classList.remove('flex');
});
document.getElementById('add-footnote-inline').addEventListener('click', () => {
  insertFootnoteFromPrompt('');
  renderFootnotesModal();
});

editor.view.dom.addEventListener('click', (e) => {
  const target = e.target.closest('sup[data-footnote-id]');
  if (!target) return;
  e.preventDefault();
  showFootnotesModal();
});

const slashCommands = [
  {
    id: 'research',
    title: 'Open Research Sidebar',
    description: 'Search, suggest case law, and ask legal questions',
    keywords: ['research', 'case', 'law', 'suggest'],
    run: () => {
      openSidebar();
      setTab('search');
    },
  },
  {
    id: 'footnote',
    title: 'Insert Footnote',
    description: 'Create a managed, renumbered footnote marker',
    keywords: ['footnote', 'note', 'citation'],
    run: () => insertFootnoteFromPrompt(''),
  },
  {
    id: 'page-break',
    title: 'Insert Page Break',
    description: 'Start a new page in exports',
    keywords: ['page', 'break', 'new page'],
    run: () => editor.chain().focus().setPageBreak().run(),
  },
  {
    id: 'table-3x3',
    title: 'Insert Table (3x3)',
    description: 'Add a new table with header row',
    keywords: ['table', 'grid'],
    run: () => editor.chain().focus().insertTable({ rows: 3, cols: 3, withHeaderRow: true }).run(),
  },
  {
    id: 'table-2x2',
    title: 'Insert Table (2x2)',
    description: 'Add compact table with header row',
    keywords: ['table', 'small', 'grid'],
    run: () => editor.chain().focus().insertTable({ rows: 2, cols: 2, withHeaderRow: true }).run(),
  },
  {
    id: 'snapshot',
    title: 'Create Snapshot',
    description: 'Save current document version immediately',
    keywords: ['version', 'snapshot', 'history'],
    run: async () => {
      await createSnapshot();
      versionsModal.classList.remove('hidden');
      versionsModal.classList.add('flex');
    },
  },
  {
    id: 'heading-2',
    title: 'Insert Heading 2',
    description: 'Apply H2 heading at cursor',
    keywords: ['heading', 'h2', 'section'],
    run: () => editor.chain().focus().toggleHeading({ level: 2 }).run(),
  },
  {
    id: 'blockquote',
    title: 'Insert Block Quote',
    description: 'Toggle block quote for selected text',
    keywords: ['quote', 'blockquote'],
    run: () => editor.chain().focus().toggleBlockquote().run(),
  },
];

function getSlashContext() {
  const { from, to } = editor.state.selection;
  if (from !== to) return null;
  const start = Math.max(1, from - 50);
  const textBefore = editor.state.doc.textBetween(start, from, ' ', '\0');
  const match = textBefore.match(/\/([a-zA-Z0-9_-]*)$/);
  if (!match) return null;
  return {
    query: (match[1] || '').toLowerCase(),
    range: { from: from - match[0].length, to: from },
    atPos: from,
  };
}

function hideSlashMenu() {
  slashState.open = false;
  slashState.items = [];
  slashState.selectedIndex = 0;
  slashState.range = null;
  slashMenu.classList.add('hidden');
}

function renderSlashMenu() {
  if (!slashState.open) {
    hideSlashMenu();
    return;
  }
  if (!slashState.items.length) {
    hideSlashMenu();
    return;
  }
  slashMenu.innerHTML = slashState.items.map((item, idx) => `
    <button class="slash-item w-full text-left p-2 border-b border-gray-100 ${idx === slashState.selectedIndex ? 'slash-item-active' : ''}" data-idx="${idx}">
      <div class="text-sm font-medium text-navy">${item.title}</div>
      <div class="text-xs text-gray-500">${item.description}</div>
    </button>
  `).join('');
  slashMenu.querySelectorAll('.slash-item').forEach(btn => btn.addEventListener('mousedown', async (e) => {
    e.preventDefault();
    await executeSlashCommand(parseInt(btn.dataset.idx, 10));
  }));
}

function maybeOpenSlashMenu() {
  const ctx = getSlashContext();
  if (!ctx) {
    hideSlashMenu();
    return;
  }
  const filtered = slashCommands.filter(cmd => {
    const haystack = `${cmd.title} ${cmd.description} ${(cmd.keywords || []).join(' ')}`.toLowerCase();
    return haystack.includes(ctx.query);
  });
  if (!filtered.length) {
    hideSlashMenu();
    return;
  }
  slashState.open = true;
  slashState.items = filtered;
  slashState.selectedIndex = Math.min(slashState.selectedIndex, filtered.length - 1);
  slashState.range = ctx.range;

  const coords = editor.view.coordsAtPos(ctx.atPos);
  const left = Math.min(coords.left, window.innerWidth - 360);
  const top = Math.min(coords.bottom + 6, window.innerHeight - 320);
  slashMenu.style.left = `${Math.max(8, left)}px`;
  slashMenu.style.top = `${Math.max(8, top)}px`;
  slashMenu.classList.remove('hidden');
  renderSlashMenu();
}

async function executeSlashCommand(index) {
  const cmd = slashState.items[index];
  const range = slashState.range;
  hideSlashMenu();
  if (!cmd) return;
  if (range) {
    editor.chain().focus().deleteRange(range).run();
  }
  await Promise.resolve(cmd.run());
  updateToolbar();
}

function handleSlashKeydown(e) {
  if (!slashState.open) return false;
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    slashState.selectedIndex = (slashState.selectedIndex + 1) % slashState.items.length;
    renderSlashMenu();
    return true;
  }
  if (e.key === 'ArrowUp') {
    e.preventDefault();
    slashState.selectedIndex = (slashState.selectedIndex - 1 + slashState.items.length) % slashState.items.length;
    renderSlashMenu();
    return true;
  }
  if (e.key === 'Enter') {
    e.preventDefault();
    executeSlashCommand(slashState.selectedIndex);
    return true;
  }
  if (e.key === 'Escape') {
    e.preventDefault();
    hideSlashMenu();
    return true;
  }
  return false;
}

document.addEventListener('click', (e) => {
  if (slashMenu.classList.contains('hidden')) return;
  if (slashMenu.contains(e.target)) return;
  if (editor.view.dom.contains(e.target)) return;
  hideSlashMenu();
});

setTab('search');
normalizeFootnotes();
updateToolbar();
</script>
{% endblock %}
