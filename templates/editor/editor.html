{% extends "editor/base.html" %}
{% block title %}{{ document.title }}{% endblock %}

{% block extra_head %}
<style>
    .tiptap-editor { outline: none; min-height: 60vh; font-family: 'Georgia', 'Times New Roman', serif; font-size: 16px; line-height: 1.8; color: #1a1a1a; }
    .tiptap-editor:focus { outline: none; }
    .tiptap-editor h1 { font-size: 1.75em; font-weight: 700; margin: 1em 0 0.5em; color: #1B2A4A; }
    .tiptap-editor h2 { font-size: 1.4em; font-weight: 700; margin: 1em 0 0.4em; color: #1B2A4A; }
    .tiptap-editor h3 { font-size: 1.15em; font-weight: 700; margin: 0.8em 0 0.3em; color: #1B2A4A; }
    .tiptap-editor p { margin: 0.4em 0; }
    .tiptap-editor ul { list-style: disc; padding-left: 1.5em; margin: 0.5em 0; }
    .tiptap-editor ol { list-style: decimal; padding-left: 1.5em; margin: 0.5em 0; }
    .tiptap-editor blockquote { border-left: 3px solid #C5A55A; padding-left: 1em; margin: 0.8em 0; color: #555; }
    .tiptap-editor hr { border: none; border-top: 1px solid #ddd; margin: 1.5em 0; }
    .tiptap-editor p.is-editor-empty:first-child::before { content: attr(data-placeholder); float: left; color: #adb5bd; pointer-events: none; height: 0; }
    .toolbar-btn { transition: all 0.1s; }
    .toolbar-btn:hover { background-color: #e5e7eb; }
    .toolbar-btn.is-active { background-color: #1B2A4A; color: white; }
    .research-open #research-sidebar { width: 400px; opacity: 1; }
    #research-sidebar { width: 0; opacity: 0; transition: width 0.2s ease, opacity 0.2s ease; }
</style>
{% endblock %}

{% block body %}
<div class="bg-white border-b border-gray-200 px-4 py-2 flex items-center justify-between">
    <div class="flex items-center gap-3">
        <a href="{% url 'dashboard' %}" class="text-gray-400 hover:text-gray-600 transition-colors" title="Back to documents">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        </a>
        <input type="text" id="doc-title" value="{{ document.title }}" class="text-lg font-semibold text-gray-900 border-none focus:outline-none focus:ring-0 bg-transparent w-96" placeholder="Untitled Document">
    </div>
    <div class="flex items-center gap-3">
        <span id="save-status" class="text-xs text-gray-400">Saved</span>
        <a href="{% url 'export_docx' document.id %}" class="bg-navy text-white px-3 py-1.5 rounded text-sm hover:bg-opacity-90 transition-colors flex items-center gap-1.5">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
            Word
        </a>
    </div>
</div>

<div id="toolbar" class="bg-white border-b border-gray-100 px-4 py-1.5 flex items-center gap-1 flex-wrap sticky top-0 z-10">
    <button class="toolbar-btn p-1.5 rounded" data-action="bold">B</button>
    <button class="toolbar-btn p-1.5 rounded italic" data-action="italic">I</button>
    <button class="toolbar-btn p-1.5 rounded underline" data-action="underline">U</button>
    <div class="w-px h-5 bg-gray-200 mx-1"></div>
    <button class="toolbar-btn px-2 py-1 rounded text-xs font-bold" data-action="heading" data-level="1">H1</button>
    <button class="toolbar-btn px-2 py-1 rounded text-xs font-bold" data-action="heading" data-level="2">H2</button>
    <button class="toolbar-btn px-2 py-1 rounded text-xs font-bold" data-action="heading" data-level="3">H3</button>
    <div class="w-px h-5 bg-gray-200 mx-1"></div>
    <button class="toolbar-btn p-1.5 rounded" data-action="bulletList">‚Ä¢ List</button>
    <button class="toolbar-btn p-1.5 rounded" data-action="orderedList">1. List</button>
    <button class="toolbar-btn p-1.5 rounded" data-action="blockquote">Quote</button>
    <div class="w-px h-5 bg-gray-200 mx-1"></div>
    <button class="toolbar-btn p-1.5 rounded" data-action="undo">Undo</button>
    <button class="toolbar-btn p-1.5 rounded" data-action="redo">Redo</button>
    <div class="flex-grow"></div>
    <button id="research-toggle" class="bg-navy text-white px-3 py-1.5 rounded text-xs hover:bg-opacity-90">üîç Research</button>
</div>

<div id="editor-shell" class="flex h-[calc(100vh-110px)] overflow-hidden">
    <div class="flex-1 overflow-y-auto">
        <div class="max-w-4xl mx-auto px-6 py-8">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 px-12 py-10 min-h-[70vh]">
                <div id="editor" class="tiptap-editor"></div>
            </div>
        </div>
    </div>

    <aside id="research-sidebar" class="bg-white border-l border-gray-200 h-full overflow-y-auto shrink-0">
        <div class="p-4 border-b border-gray-100 flex items-center justify-between">
            <h3 class="text-sm font-semibold text-navy">Research</h3>
            <button id="research-close" class="text-gray-400 hover:text-gray-700">‚úï</button>
        </div>
        <div class="p-3 border-b border-gray-100 flex gap-2">
            <button id="tab-search" class="px-3 py-1 text-xs rounded bg-navy text-white">Search</button>
            <button id="tab-categories" class="px-3 py-1 text-xs rounded border">Categories</button>
        </div>

        <div id="search-panel" class="p-3 space-y-2">
            <input id="research-query" class="w-full border rounded px-2 py-1 text-sm" placeholder="Search case law..." />
            <div class="flex gap-2">
                <button id="run-search" class="flex-1 px-2 py-1 text-xs bg-gold text-navy rounded">Search</button>
                <button id="run-suggest" class="flex-1 px-2 py-1 text-xs border rounded">Suggest from Selection</button>
            </div>
        </div>

        <div id="categories-panel" class="p-3 hidden"></div>
        <div id="results" class="p-3 space-y-2"></div>

        <div id="case-panel" class="hidden absolute right-0 top-0 w-[400px] h-full bg-white border-l border-gray-200 overflow-y-auto z-20">
            <div class="p-3 border-b flex justify-between items-center">
                <button id="case-back" class="text-xs text-navy">‚Üê Back to results</button>
                <button id="insert-citation-top" class="text-xs bg-gold text-navy px-2 py-1 rounded">Insert Citation</button>
            </div>
            <div id="case-detail" class="p-3 text-sm"></div>
        </div>
    </aside>
</div>
{% endblock %}

{% block extra_scripts %}
<script type="importmap">{"imports":{"@tiptap/core":"https://esm.sh/@tiptap/core@2.11.5","@tiptap/starter-kit":"https://esm.sh/@tiptap/starter-kit@2.11.5","@tiptap/extension-underline":"https://esm.sh/@tiptap/extension-underline@2.11.5","@tiptap/extension-placeholder":"https://esm.sh/@tiptap/extension-placeholder@2.11.5"}}</script>
<script type="module">
import { Editor } from '@tiptap/core';
import StarterKit from '@tiptap/starter-kit';
import Underline from '@tiptap/extension-underline';
import Placeholder from '@tiptap/extension-placeholder';

const docId = '{{ document.id }}';
const csrfToken = '{{ csrf_token }}';
let currentCase = null;

let initialContent;
try { initialContent = JSON.parse('{{ document.content|escapejs }}'); }
catch { initialContent = { type: 'doc', content: [{ type: 'paragraph' }] }; }

const editor = new Editor({
  element: document.getElementById('editor'),
  extensions: [StarterKit, Underline, Placeholder.configure({ placeholder: 'Start writing...' })],
  content: initialContent,
  editorProps: { attributes: { class: 'tiptap-editor' } },
});

const saveStatus = document.getElementById('save-status');
let saveTimeout = null;
let isSaving = false;
async function saveContent() {
  if (isSaving) return;
  isSaving = true;
  saveStatus.textContent = 'Saving...';
  try {
    const response = await fetch(`/api/save/${docId}/`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }, body: JSON.stringify({ content: editor.getJSON() }) });
    saveStatus.textContent = response.ok ? 'Saved' : 'Error saving';
  } catch { saveStatus.textContent = 'Error saving'; }
  isSaving = false;
}
editor.on('update', () => { clearTimeout(saveTimeout); saveStatus.textContent = 'Unsaved changes'; saveTimeout = setTimeout(saveContent, 3000); updateToolbar(); });

document.getElementById('doc-title').addEventListener('input', (() => {
  let timeout = null;
  return () => {
    clearTimeout(timeout);
    timeout = setTimeout(async () => {
      await fetch(`/api/title/${docId}/`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }, body: JSON.stringify({ title: document.getElementById('doc-title').value }) });
    }, 800);
  };
})());

document.querySelectorAll('.toolbar-btn').forEach(btn => btn.addEventListener('click', () => {
  const a = btn.dataset.action;
  if (a === 'bold') editor.chain().focus().toggleBold().run();
  if (a === 'italic') editor.chain().focus().toggleItalic().run();
  if (a === 'underline') editor.chain().focus().toggleUnderline().run();
  if (a === 'heading') editor.chain().focus().toggleHeading({ level: parseInt(btn.dataset.level) }).run();
  if (a === 'bulletList') editor.chain().focus().toggleBulletList().run();
  if (a === 'orderedList') editor.chain().focus().toggleOrderedList().run();
  if (a === 'blockquote') editor.chain().focus().toggleBlockquote().run();
  if (a === 'undo') editor.chain().focus().undo().run();
  if (a === 'redo') editor.chain().focus().redo().run();
  updateToolbar();
}));

function updateToolbar() {
  document.querySelectorAll('.toolbar-btn').forEach(btn => {
    const a = btn.dataset.action;
    btn.classList.toggle('is-active',
      (a === 'bold' && editor.isActive('bold')) ||
      (a === 'italic' && editor.isActive('italic')) ||
      (a === 'underline' && editor.isActive('underline')) ||
      (a === 'heading' && editor.isActive('heading', { level: parseInt(btn.dataset.level) })) ||
      (a === 'bulletList' && editor.isActive('bulletList')) ||
      (a === 'orderedList' && editor.isActive('orderedList')) ||
      (a === 'blockquote' && editor.isActive('blockquote')));
  });
}
editor.on('selectionUpdate', updateToolbar);

const shell = document.getElementById('editor-shell');
document.getElementById('research-toggle').addEventListener('click', () => shell.classList.toggle('research-open'));
document.getElementById('research-close').addEventListener('click', () => shell.classList.remove('research-open'));

function validityBadge(status) {
  if (status === 'good_law') return '<span class="text-green-700">‚úÖ good law</span>';
  if (status === 'questioned') return '<span class="text-yellow-700">‚ö†Ô∏è questioned</span>';
  if (status === 'overruled') return '<span class="text-red-700">‚ùå overruled</span>';
  return '<span class="text-gray-500">‚¨ú unknown</span>';
}

function caseCard(item) {
  const holding = item.holding || item.summary || '';
  return `<div class="border rounded p-2 hover:border-navy bg-white">
    <button class="case-open text-left w-full text-sm font-semibold text-navy" data-id="${item.document_id}">${item.case_name}</button>
    <div class="text-xs text-gray-600">${item.citation || ''}</div>
    <div class="text-xs">${validityBadge(item.validity_status)}</div>
    <div class="text-xs text-gray-700 mt-1">${holding.slice(0, 200)}</div>
    <div class="mt-2 flex gap-2">
      <button class="insert-citation text-xs bg-gold text-navy px-2 py-1 rounded" data-case='${JSON.stringify(item).replace(/'/g, "&#39;")}'>Insert Citation</button>
      <button class="similar text-xs border px-2 py-1 rounded" data-id="${item.document_id}">Find Similar</button>
    </div>
  </div>`;
}

async function runSuggest(text) {
  const res = await fetch('/api/research/suggest/', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }, body: JSON.stringify({ text }) });
  const data = await res.json();
  renderResults(data.results || []);
}

async function runCategory(id) {
  const res = await fetch(`/api/research/category/${id}/`);
  const data = await res.json();
  renderResults(data.results || []);
}

function renderResults(items) {
  const node = document.getElementById('results');
  node.innerHTML = items.length ? items.map(caseCard).join('') : '<div class="text-xs text-gray-500">No results.</div>';
  node.querySelectorAll('.insert-citation').forEach(btn => btn.addEventListener('click', () => {
    const item = JSON.parse(btn.dataset.case);
    insertCitation(item);
  }));
  node.querySelectorAll('.case-open').forEach(btn => btn.addEventListener('click', async () => openCase(btn.dataset.id)));
  node.querySelectorAll('.similar').forEach(btn => btn.addEventListener('click', async () => {
    const res = await fetch(`/api/research/similar/${btn.dataset.id}/`);
    const data = await res.json();
    renderResults(data.results || []);
  }));
}

function insertCitation(item) {
  const year = item.decision_date ? new Date(item.decision_date).getUTCFullYear() : '';
  const courtYear = item.court && year ? ` (${item.court} ${year})` : '';
  editor.chain().focus().insertContent([{ type: 'text', text: item.case_name || '', marks: [{ type: 'italic' }] }, { type: 'text', text: `, ${item.citation || ''}${courtYear}` }]).run();
}

document.getElementById('insert-citation-top').addEventListener('click', () => { if (currentCase) insertCitation(currentCase); });

async function openCase(docId) {
  const res = await fetch(`/api/research/case/${docId}/`);
  const data = await res.json();
  currentCase = data;
  document.getElementById('case-panel').classList.remove('hidden');
  document.getElementById('case-detail').innerHTML = `
    <h4 class="font-semibold text-navy">${data.case_name}</h4>
    <div class="text-xs text-gray-600">${data.citation || ''}</div>
    <div class="text-xs mt-1">${validityBadge(data.validity?.status)}</div>
    <h5 class="mt-3 font-semibold text-xs text-gray-700">Holdings</h5>
    ${(data.holdings || []).map(h => `<div class="text-xs mt-1"><span class="font-semibold">${h.legal_issue || ''}</span><br>${h.rule || ''}</div>`).join('')}
    <h5 class="mt-3 font-semibold text-xs text-gray-700">Full Text</h5>
    <pre class="whitespace-pre-wrap text-xs bg-gray-50 p-2 rounded mt-1">${(data.full_text || '').slice(0, 20000)}</pre>`;
}

document.getElementById('case-back').addEventListener('click', () => document.getElementById('case-panel').classList.add('hidden'));

document.getElementById('run-search').addEventListener('click', () => runSuggest(document.getElementById('research-query').value));
document.getElementById('run-suggest').addEventListener('click', () => {
  const selected = editor.state.doc.textBetween(editor.state.selection.from, editor.state.selection.to, ' ');
  runSuggest(selected || editor.getText().slice(0, 1000));
});

document.getElementById('tab-search').addEventListener('click', () => {
  document.getElementById('search-panel').classList.remove('hidden');
  document.getElementById('categories-panel').classList.add('hidden');
});
document.getElementById('tab-categories').addEventListener('click', async () => {
  document.getElementById('search-panel').classList.add('hidden');
  document.getElementById('categories-panel').classList.remove('hidden');
  const res = await fetch('/api/research/categories/');
  const data = await res.json();
  document.getElementById('categories-panel').innerHTML = (data.categories || []).map(c => `<button class="cat-btn w-full text-left text-sm p-2 border-b hover:bg-gray-50" data-id="${c.id}">${c.name}</button>`).join('');
  document.querySelectorAll('.cat-btn').forEach(btn => btn.addEventListener('click', () => runCategory(btn.dataset.id)));
});

document.addEventListener('keydown', (e) => { if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); clearTimeout(saveTimeout); saveContent(); } });
window.addEventListener('beforeunload', () => { if (saveTimeout) saveContent(); });
</script>
{% endblock %}
